# Adding glog as a CMake external project causes missing `log_severity.h`

## Motivation

This repository is meant to demonstrate a proof-of-concept for what I believe is
a bug with `glog`'s use of CMake.

Consider a minimal C++ project with the following requirements:

+ `glog` >= 0.3.5 as a CMake `ExternalProject`
+ `gflags` >= 2.2 as a git submodule (also repros using `ExternalProject`)

Ideally, we want to have `glog` to build with the local `gflags`.

## Reproduction

If we clone this repo and proceed with the build like so:

    $ git clone --recurse-submodules https://github.com/Imxset21/cmake_glog_example.git
    $ cd cmake_glog_example
    $ mkdir build
    $ cd build
    $ cmake ..
    $ make
    
We'll see an error indicating a missing `glog` header:

    [...]
    Scanning dependencies of target example
    [ 92%] Building CXX object CMakeFiles/example.dir/Example.cpp.o
    In file included from /home/prittner/git/cmake_glog_gflags/Example.cpp:2:0:
    /home/prittner/git/cmake_glog_gflags/build/glog-master/glog/logging.h:512:31: fatal error: glog/log_severity.h: No such file or directory
    compilation terminated.
    CMakeFiles/example.dir/build.make:62: recipe for target 'CMakeFiles/example.dir/Example.cpp.o' failed
    make[2]: *** [CMakeFiles/example.dir/Example.cpp.o] Error 1
    CMakeFiles/Makefile2:104: recipe for target 'CMakeFiles/example.dir/all' failed
    make[1]: *** [CMakeFiles/example.dir/all] Error 2
    Makefile:127: recipe for target 'all' failed
    make: *** [all] Error 2

## Root Cause

The issue stems from what may be an oversight in the `glog`'s [`CMakeLists.txt`](https://github.com/google/glog/blob/master/CMakeLists.txt#L368).

Since the `log_severity.h` file is not a `*.in` file, it seems as though it is
never properly generated by CMake's `make` build:

    [After having performed the build steps above]
    $ find . -name log_severity.h
    [Would expect ./build/glog-master/glog/log_severity.h, but we get nothing]


## Proposed fix

The proposed fix consists of three parts:

1) Rename `src/glog/log_severity.h` â†’ `src/glog/log_severity.h.in`
2) Tell CMake to configure the `.h.in` file using `configure_file`
3) Fix the reference linked above to use `${CMAKE_CURRENT_BINARY_DIR}/glog/log_severity.h`

As seen [here](https://github.com/Imxset21/glog/commit/39fdb43197533ade1112947d9f50eb62b10731fc).

As a result, when we point our `ExternalProject`'s `GIT_REPOSITORY` variable at
`https://github.com/Imxset21/glog` instead, and repeat the build process:

    $ make
    [...]
    Scanning dependencies of target utilities_unittest
    [ 95%] Building CXX object CMakeFiles/utilities_unittest.dir/src/utilities_unittest.cc.o
    [100%] Linking CXX executable utilities_unittest
    [100%] Built target utilities_unittest
    [ 71%] No install step for 'glog-master'
    [ 78%] Completed 'glog-master'
    [ 85%] Built target glog-master
    [ 92%] Building CXX object CMakeFiles/example.dir/Example.cpp.o
    [100%] Linking CXX executable example
    [100%] Built target example
    $ ./example --dummy=true -logtostderr
    I0218 15:58:25.906924 12763 Example.cpp:9] Flag dummy is: true

and the issue is resolved.
